<script>
/* ---------------------- ITEM DATABASE (3D ready) ----------------------- */
const ITEM_DB = {
  "item:shirt:001": {
    title: "Navy Vintage Tee",
    size: "M",
    brand: "LabelCo",
    info: "Vintage cut, 100% cotton. Machine wash cold.",
    overlay: "https://via.placeholder.com/300x400?text=T-Shirt",
    model3d: "https://example.com/models/shirt001.glb",   // 3D model of the shirt
    recs: ["khaki_chinos", "white_sneakers"]
  },
  "item:jacket:002": {
    title: "Utility Jacket",
    size: "L",
    brand: "FieldWorks",
    info: "Lightweight, water-resistant. Recommend layering.",
    overlay: "https://via.placeholder.com/300x400?text=Jacket",
    model3d: "https://example.com/models/jacket002.glb",  // 3D model of the jacket
    recs: ["black_boots", "denim_jeans"]
  }
};

const RECS_FRIENDLY = {
  "khaki_chinos": "Khaki chinos",
  "white_sneakers": "White sneakers",
  "black_boots": "Black boots",
  "denim_jeans": "Denim jeans"
};

/* ---------------------- CAMERA & QR LOGIC ----------------------- */
const video = document.getElementById('camera');
const canvas = document.getElementById('videoCanvas');
const ctx = canvas.getContext('2d');
const overlayImg = document.getElementById('overlay');
const avatarModel = document.getElementById('avatarModel');
const clothingModel = document.getElementById('clothingModel');
const status = document.getElementById('status');
const infoPanel = document.getElementById('infoPanel');
const itemTitle = document.getElementById('itemTitle');
const itemMeta = document.getElementById('itemMeta');
const recs = document.getElementById('recs');
const portraitInfo = document.getElementById('portraitInfo');
const pTitle = document.getElementById('pTitle');
const pMeta = document.getElementById('pMeta');
const pRecs = document.getElementById('pRecs');
const modeText = document.getElementById('modeText');

let currentItem = null;
let scanning = false;

async function startCamera(){
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });
    video.srcObject = stream;
    await video.play();
  } catch(e){
    alert("Camera blocked or not available. Use HTTPS.");
  }
}

/* ---------------------- QR SCAN ----------------------- */
function scanFrameForQR(){
  if(video.readyState !== video.HAVE_ENOUGH_DATA) return null;
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts:"attemptBoth" });
  if(code){
    ctx.beginPath();
    ctx.moveTo(code.location.topLeftCorner.x, code.location.topLeftCorner.y);
    ctx.lineTo(code.location.topRightCorner.x, code.location.topRightCorner.y);
    ctx.lineTo(code.location.bottomRightCorner.x, code.location.bottomRightCorner.y);
    ctx.lineTo(code.location.bottomLeftCorner.x, code.location.bottomLeftCorner.y);
    ctx.closePath();
    ctx.lineWidth = 4;
    ctx.strokeStyle = "red";
    ctx.stroke();
  }
  return code ? code.data : null;
}

/* ---------------------- HANDLE SCAN → SHOW 3D ----------------------- */
function handleScan(payload){
  status.textContent = "Scanned: " + payload;
  const item = ITEM_DB[payload];
  if(!item){ alert("Unknown QR: "+payload); return; }

  currentItem = item;

  // Show 3D models
  avatarModel.style.display = "block";
  clothingModel.style.display = "block";
  clothingModel.src = item.model3d || "";

  // Hide 2D overlay
  overlayImg.style.display = "none";

  // Update info panel
  itemTitle.textContent = item.title;
  itemMeta.textContent = item.brand + " • " + item.size + "\n" + item.info;
  recs.innerHTML = "";
  item.recs.forEach(r => {
    const d = document.createElement("div");
    d.textContent = RECS_FRIENDLY[r] || r;
    recs.appendChild(d);
  });
  infoPanel.style.display = "block";

  // Portrait info
  pTitle.textContent = item.title;
  pMeta.textContent = item.brand + " — " + item.size + "\n" + item.info;
  pRecs.innerHTML = "<strong>Recommendations</strong><br>" +
    item.recs.map(r => RECS_FRIENDLY[r] || r).join(", ");
}

</script>
