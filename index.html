<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>AR Clothing Prototype — Demo</title>

<style>
:root{--bg:#0b0b0b;--panel:#111;--accent:#ffd166}
html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#000;color:#eee;}
.screen{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;transition:opacity .4s ease;}
.screen.hidden{opacity:0;pointer-events:none;}
#titleScreen img{width:240px;max-width:70%;margin-bottom:20px;}
#titleScreen .tap{font-size:18px;opacity:0.7;}
#pinScreen{padding:20px;text-align:center;background:#000;}
#pinDisplay{font-size:32px;letter-spacing:14px;margin-bottom:24px;}
.keypad{display:grid;grid-template-columns:repeat(3,70px);gap:12px;justify-content:center}
.keypad button{background:#222;border:1px solid #444;color:#fff;font-size:22px;padding:16px;border-radius:8px}
.keypad button:active{background:#333;}
.app{height:100%;display:none;flex-direction:column;background:var(--bg);}
#view{position:relative;flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden}
video#camera{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);}
canvas#videoCanvas{position:absolute;top:0;left:0;width:100%;height:100%;}
img#overlay{position:absolute;left:50%;top:40%;transform:translate(-50%,-50%);max-width:70%;opacity:0.95;pointer-events:none}
.topbar{display:flex;gap:8px;padding:8px;background:linear-gradient(180deg,rgba(0,0,0,0.4),transparent);position:absolute;top:0;left:0;right:0;z-index:20}
button{background:#222;border:1px solid #333;color:#fff;padding:8px 10px;border-radius:6px}
.infoPanel{position:absolute;right:8px;bottom:8px;background:var(--panel);padding:12px;border-radius:10px;max-width:46%;z-index:20}
.hint{position:absolute;left:8px;bottom:8px;background:rgba(0,0,0,0.45);padding:8px;border-radius:8px;font-size:12px}
.modeBadge{position:absolute;left:50%;top:10px;transform:translateX(-50%);background:#111;padding:6px 12px;border-radius:999px;border:1px solid #222;z-index:20}
.portraitInfo{display:none;padding:12px}
@media (orientation: portrait){
  .portraitInfo{display:block;background:var(--panel);height:100%;overflow:auto}
  #view{display:none}
}
footer{padding:8px;text-align:center;font-size:12px;background:linear-gradient(0deg,rgba(0,0,0,0.5),transparent)}
.metaLabel{color:#ccc;font-size:13px}
</style>
</head>
<body>

<div id="titleScreen" class="screen">
  <img src="logo.png" alt="Logo">
  <div class="tap">Tap to Continue</div>
</div>

<div id="pinScreen" class="screen hidden">
  <h2>Enter PIN</h2>
  <div id="pinDisplay">____</div>
  <div class="keypad">
    <button data-n="1">1</button>
    <button data-n="2">2</button>
    <button data-n="3">3</button>
    <button data-n="4">4</button>
    <button data-n="5">5</button>
    <button data-n="6">6</button>
    <button data-n="7">7</button>
    <button data-n="8">8</button>
    <button data-n="9">9</button>
    <button id="pinClear">C</button>
    <button data-n="0">0</button>
    <button id="pinDelete">⌫</button>
  </div>
</div>

<div class="app" id="app">
  <div id="view">
    <video id="camera" autoplay playsinline></video>
    <canvas id="videoCanvas"></canvas>
    <img id="logoOverlay" src="logo.png" 
     style="position:absolute; top:10px; left:10px; width:120px; opacity:0.9; z-index:30; pointer-events:none;">
    <img id="overlay" src="" style="display:none">
    <model-viewer id="avatarModel" src="avatar.glb" alt="Avatar" style="display:none; width:100%; height:100%; position:absolute; top:0; left:0; z-index:5;" camera-controls auto-rotate></model-viewer>
    <model-viewer
    id="avatarModel2"
    src="avatar2.glb"
    alt="Avatar 2"
    style="display:none; width:100%; height:100%; position:absolute; top:0; left:0; z-index:5;"
    camera-controls
    auto-rotate>
    </model-viewer>
    <model-viewer
    id="avatarModel3"
    src="avatar3.glb"
    alt="Avatar 3"
    style="display:none; width:100%; height:100%; position:absolute; top:0; left:0; z-index:5;"
    camera-controls
    auto-rotate>
    </model-viewer>
    <model-viewer id="clothingModel" src="Hammer.glb" alt="Clothing" style="display:none; width:45%; height:45%; position:absolute; top:35%; left:50%; transform:translate(-50%,-50%); pointer-events:auto; z-index:6;" camera-controls interaction-prompt="none" disable-pan auto-rotate="false"></model-viewer>
    <model-viewer 
    id="clothingModel2" 
    src="utility_jacket.glb" 
    alt="Clothing" 
    scale="1.5 1.5 1.5" 
    style="display:none; width:200%; height:200%; position:absolute; top:35%; left:50%; transform:translate(-50%,-50%); pointer-events:auto; z-index:6;" 
    camera-controls 
    interaction-prompt="none" 
    disable-pan 
    auto-rotate="false">
    </model-viewer>

    <div class="topbar">
      <button id="scanBtn">Scan QR</button>
      <button id="toggleMirror">Toggle Mirror</button>
      <button id="toggleAvatar">Switch Body</button>
      <div style="flex:1"></div>
      <div id="status">No item scanned</div>
    </div>

    <div class="modeBadge" id="modeBadge">Mode: <span id="modeText">AR try-on</span></div>

    <div class="infoPanel" id="infoPanel" style="display:none">
      <div><strong id="itemTitle"></strong></div>
      <div class="metaLabel" id="itemMeta"></div>
      <div style="margin-top:8px;">Recommendations:</div>
      <div id="recs"></div>
    </div>

    <div class="hint">Tip: Hold horizontally for try-on, vertically for item info</div>
  </div>

  <div class="portraitInfo" id="portraitInfo">
<div class="portraitInfo" id="portraitInfo">
    <img src="logo.png" 
     style="width:140px; display:block; margin:10px auto 20px auto; opacity:0.9;">
    <h2 id="pTitle">No item scanned</h2>
    <p id="pMeta"></p>

    <h3>Care Instructions</h3>
    <p id="pCare"></p>

    <h3>Material & Manufacturing</h3>
    <p id="pMaterial"></p>
    <p id="pManufacture"></p>

    <h3>Potential Irritants</h3>
    <p id="pIrritants"></p>

    <h3>Disposal</h3>
    <p id="pDisposal"></p>

    <h3>Recommendations</h3>
    <div id="pRecs"></div>

    <br>
    <a id="pCheckout" href="checkout.html" style="color:#ffd166; font-weight:bold;" target="_blank">
        Buy Now →
    </a>
  </div>

  <footer>Prototype — student build. Serve via HTTPS for camera access.</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.min.js"></script>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<script>
/* ---------------------- TITLE → PIN LOGIC ----------------------- */
const titleScreen = document.getElementById("titleScreen");
const pinScreen   = document.getElementById("pinScreen");
const app         = document.getElementById("app");

const CORRECT_PIN = "1234";
let enteredPIN = "";

titleScreen.addEventListener("click", () => {
  titleScreen.classList.add("hidden");
  setTimeout(() => pinScreen.classList.remove("hidden"), 400);
});

document.querySelectorAll("#pinScreen button[data-n]").forEach(btn => {
  btn.addEventListener("click", () => {
    if (enteredPIN.length < 4) {
      enteredPIN += btn.dataset.n;
      updatePinDisplay();
      if (enteredPIN.length === 4) checkPIN();
    }
  });
});

document.getElementById("pinClear").onclick = () => { enteredPIN=""; updatePinDisplay(); };
document.getElementById("pinDelete").onclick = () => { enteredPIN=enteredPIN.slice(0,-1); updatePinDisplay(); };

function updatePinDisplay(){ document.getElementById("pinDisplay").textContent=enteredPIN.padEnd(4,"_"); }

function checkPIN(){
  if(enteredPIN===CORRECT_PIN){
    pinScreen.classList.add("hidden");
    setTimeout(()=> {
      app.style.display = "flex";
      startCamera();
      updateMode();
    },400);
  } else { alert("Incorrect PIN"); enteredPIN=""; updatePinDisplay(); }
}

/* ---------------------- ITEM DATABASE ----------------------- */
const ITEM_DB = {
  "item:shirt:001":{
    title:"Navy Vintage Tee",
    size:"M",
    brand:"LabelCo",
    info:"Vintage cut, 100% cotton. Machine wash cold.",
    overlay:"https://via.placeholder.com/300x400?text=T-Shirt",
    model3d: "models/Hammer.glb",
    manufacture: "Made in Germany",
    materials: "100% Organic Cotton",
    potentialIrritants: "None",
    care: "Machine wash cold, tumble dry low",
    disposal: "Recycle or donate; biodegradable packaging",
    checkoutLink: "checkout.html",
    recs:["khaki_chinos","white_sneakers"]
  },
  "item:jacket:002":{
    title:"Utility Jacket",
    size:"L",
    brand:"FieldWorks",
    info:"Lightweight, water-resistant. Recommend layering.",
    overlay:"https://via.placeholder.com/300x400?text=Jacket",
    model3d:"models/utility_jacket.glb",
    manufacture: "Made in Canada",
    materials: "100% Organic Cotton",
    potentialIrritants: "None",
    care: "Machine wash cold, tumble dry low",
    disposal: "Recycle or donate; biodegradable packaging",
    checkoutLink: "checkout.html",
    recs:["black_boots","denim_jeans"]
  }
};

const RECS_FRIENDLY = {
  "khaki_chinos":"Khaki chinos",
  "white_sneakers":"White sneakers",
  "black_boots":"Black boots",
  "denim_jeans":"Denim jeans"
};

/* ---------------------- CAMERA + QR LOGIC ----------------------- */
const video=document.getElementById('camera');
const canvas=document.getElementById('videoCanvas');
const ctx=canvas.getContext('2d');
const overlayImg=document.getElementById('overlay');
const status=document.getElementById('status');
const infoPanel=document.getElementById('infoPanel');
const itemTitle=document.getElementById('itemTitle');
const itemMeta=document.getElementById('itemMeta');
const recs=document.getElementById('recs');
const portraitInfo=document.getElementById('portraitInfo');
const pTitle=document.getElementById('pTitle');
const pMeta=document.getElementById('pMeta');
const pRecs=document.getElementById('pRecs');
const modeText=document.getElementById('modeText');

let currentItem=null;
let scanning=false;

async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
    video.srcObject=stream;
    await video.play();
  }catch(e){ alert("Camera blocked or unavailable. Use HTTPS."); }
}

function scanFrameForQR(){
  if(video.readyState!==video.HAVE_ENOUGH_DATA)return null;
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
  const code = jsQR(imageData.data,imageData.width,imageData.height,{ inversionAttempts:"attemptBoth" });
  if(code){
    ctx.beginPath();
    ctx.moveTo(code.location.topLeftCorner.x, code.location.topLeftCorner.y);
    ctx.lineTo(code.location.topRightCorner.x, code.location.topRightCorner.y);
    ctx.lineTo(code.location.bottomRightCorner.x, code.location.bottomRightCorner.y);
    ctx.lineTo(code.location.bottomLeftCorner.x, code.location.bottomLeftCorner.y);
    ctx.closePath();
    ctx.lineWidth=4;
    ctx.strokeStyle="red";
    ctx.stroke();
  }
  return code ? code.data : null;
}

document.getElementById('scanBtn').addEventListener('click',()=>{
  const scanBtn = document.getElementById('scanBtn');
  if(scanning){ scanning=false; scanBtn.textContent="Scan QR"; return; }
  scanning=true; scanBtn.textContent="Stop scanning";

  const loop=()=>{
    if(!scanning)return;
    const q=scanFrameForQR();
    if(q){ scanning=false; scanBtn.textContent="Scan QR"; handleScan(q); }
    else requestAnimationFrame(loop);
  };
  loop();
});

/* ---------------------- handleScan ----------------------- */
function handleScan(payload){
  status.textContent = "Scanned: " + payload;
  const item = ITEM_DB[payload];
  if(!item){ 
    alert("Unknown QR: " + payload); 
    return; 
  }

  currentItem=item;

// ---- Show the correct 3D models ----
const avatar = document.getElementById("avatarModel");
const avatar2 = document.getElementById("avatarModel2");
const avatar3 = document.getElementById("avatarModel3");

const clothing = document.getElementById("clothingModel");
const clothing2 = document.getElementById("clothingModel2");

// Default: avatarModel visible
avatar.style.display = "block";
avatar2.style.display = "none";
avatar3.style.display = "none";

// Show clothing model depending on the item
clothing.style.display = "block";
clothing.src = item.model3d || "Hammer.glb";

// Hide the jacket unless used
clothing2.style.display = "none";

// Disable auto-rotate
avatar.autoRotate = false;
avatar2.autoRotate = false;
avatar3.autoRotate = false;
clothing.autoRotate = false;
clothing2.autoRotate = false;

// Fix rotation of clothing only (your 180° flip)
clothing.setAttribute("rotation", "180deg 0deg 0deg");
clothing2.setAttribute("rotation", "180deg 0deg 0deg");

// ---- Identify which avatar is active ----
function getActiveAvatar() {
  if (avatar3.style.display === "block") return avatar3;
  if (avatar2.style.display === "block") return avatar2;
  return avatar; // default
}

// ---- Sync clothing rotation to avatar rotation ----
function syncClothingRotation() {
  const active = getActiveAvatar();
  const orbit = active.getCameraOrbit();

  const theta = orbit.theta;
  const phi = orbit.phi;
  const radius = orbit.radius;

  // Apply same rotation but add your 180° X flip
  clothing.cameraOrbit = `${theta}rad ${phi}rad ${radius}rad`;

  requestAnimationFrame(syncClothingRotation);
}

syncClothingRotation();

// ⭐ Update info panels
itemTitle.textContent = item.title;
itemMeta.textContent = item.brand + " • " + item.size + "\n" + item.info;

recs.innerHTML = "";
item.recs.forEach(r => {
  const d = document.createElement("div");
  d.textContent = RECS_FRIENDLY[r] || r;
  recs.appendChild(d);
});

infoPanel.style.display = "block";
pTitle.textContent = item.title;
pMeta.textContent = item.brand + " — " + item.size + "\n" + item.info;

pCare.textContent = item.care || "—";
pMaterial.textContent = item.materials || "—";
pManufacture.textContent = item.manufacture || "—";
pIrritants.textContent = item.potentialIrritants || "—";
pDisposal.textContent = item.disposal || "—";

pRecs.innerHTML = item.recs.map(r => RECS_FRIENDLY[r] || r).join(", ");

document.getElementById("pCheckout").href = item.checkoutLink || "#";
}

/* ---------------------- Orientation ----------------------- */
function updateMode(){
  const isPortrait = window.matchMedia("(orientation: portrait)").matches;
  if(isPortrait){
    modeText.textContent="Info";
    document.getElementById("view").style.display="none";
    portraitInfo.style.display="block";
  }else{
    modeText.textContent="AR try-on";
    document.getElementById("view").style.display="flex";
    portraitInfo.style.display="none";
  }
}

/* ---------------------- AVATAR SWITCH ----------------------- */
const avatar1 = document.getElementById("avatarModel");
const avatar2 = document.getElementById("avatarModel2");
const avatar3 = document.getElementById("avatarModel3");

document.getElementById("toggleAvatar").addEventListener("click", () => {
  // Cycle through 3 avatars
  if (avatar1.style.display === "block") {
    // avatar1 → avatar2
    avatar1.style.display = "none";
    avatar2.style.display = "block";
    avatar3.style.display = "none";
  } else if (avatar2.style.display === "block") {
    // avatar2 → avatar3
    avatar1.style.display = "none";
    avatar2.style.display = "none";
    avatar3.style.display = "block";
  } else {
    // avatar3 → avatar1
    avatar1.style.display = "block";
    avatar2.style.display = "none";
    avatar3.style.display = "none";
  }
});

window.addEventListener("orientationchange",updateMode);
window.addEventListener("resize",updateMode);
</script>

</body>
</html>
